# Holly Grace — Development Environment Specification v1.0

**Generated:** 17 February 2026

## Purpose

This document is the **definitive reference** for development tooling, dependencies, standards, and CI configuration for the Holly Grace platform. Every developer touching the codebase follows this specification. Decisions here are binding — deviations from this specification require an Architecture Decision Record (ADR). This is not a guide; it is a contract.

---

## 1. Language & Runtime

### Python (Backend)

**Version:** 3.12+ (minimum: 3.12.0, recommend 3.13.x for latest optimizations)

**Rationale:** 3.12 introduces adaptive specialization and per-interpreter GIL, enabling true async/await concurrency. Holly requires fine-grained async boundaries (Kernel gating, workflow checkpoints, sandbox gRPC). Earlier versions have overhead that compounds across hundreds of concurrent lanes.

**Virtual Environment:** `uv` (Astral's replacement for venv/virtualenv)

**Rationale:** `uv` is 10–100x faster than pip/venv, deterministic lock files enable bit-identical reproductions, and integrates with Python version management. Given Holly's frequent rebuilds during Slice 1–3 (Phase A–B), speed matters.

**Package Manager:** `uv pip` (via `uv sync`)

**Type Checking:** `mypy` with strict mode enabled

- Configuration file: `/pyproject.toml` → `[tool.mypy]` with `strict = true`
- Enforce on all public APIs (function signatures, class attributes, exported types)
- Non-strict allowed only in test fixtures and sandbox experiment code; document each exemption with `# type: ignore[...]`

### TypeScript/React (Console)

**Node Version:** 20.x LTS (minimum: 20.10.0)

**Rationale:** Node 20 stabilized OpenTelemetry support (used in observability integration), native fetch API, and worker thread stability. Holly's console must stream topology updates, goal traces, and metrics in real-time without blocking.

**Package Manager:** `pnpm` (Performant NPM)

**Rationale:** Monorepo-friendly, enforces peer dependency strictness, faster installs via flat node_modules with hoisting. Replaces npm/yarn.

**React Version:** 18.3+ (minimum 18.2 for Suspense; recommend 18.3 for use-transition hooks)

**Build Tool:** `Vite` (per RTD v0.1.0.4)

- Config: `/console/vite.config.ts`
- Esbuild-based, HMR in <100ms, production bundle splitting by route
- Output: `/console/dist/` (served by ALB + nginx in dev)

**State Management:** `Zustand`

**Rationale:** Minimal boilerplate (one file per store), atomic updates prevent React render thrashing, native TypeScript. Replaces Redux/Recoil. Holly's stores: `chat`, `topology`, `goal`, `metrics`, `auth`.

**Styling:** `Tailwind CSS` (per RTD)

- Config: `/console/tailwind.config.js`
- Content paths scan `src/**/*.{tsx,ts}`
- Custom colors defined for consistency (e.g., `--holly-red` for Celestial emphasis)
- No CSS-in-JS; Tailwind classnames only

**UI Component Library:** Headless UI components (Radix UI recommended) + Tailwind utilities

### TLA+ (Formal Verification)

**TLA+ Toolbox:** 1.8.0+

**Rationale:** Phase B (steps 14.1–14.3) requires formal verification of Kernel state machine (KernelContext, K1–K8) and Sandbox isolation. TLA+ Toolbox includes TLC model checker (exhaustive state-space search) and simulation.

**TLC Model Checker:** Bundled with Toolbox

**Key Specs (per README entries):**
- `kernel-context-state-machine.tla` — KernelContext lifecycle, entry/exit invariants
- `sandbox-isolation.tla` — namespace/seccomp enforcement, no-escape predicate
- `egress-filtering.tla` — allowlist/redaction/rate-limit ordering guarantees

---

## 2. Dependencies (Backend)

Organized by functional domain. All versions pinned in `uv.lock` (generated by `uv sync`).

### Core Framework

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `starlette` | 0.40+ | HTTP request routing, middleware, WebSocket support | Per SAD: Starlette layer before FastAPI (if added). K-lightweight. |
| `pydantic` | 2.8+ | Config management, data validation, ICD schema definitions | v2 required: Pydantic v2 generators for hypothesis property-based tests. |
| `uvicorn` | 0.30+ | ASGI server (async, multi-worker, H2C support for gRPC) | Production: uvicorn with gunicorn or systemd socket activation. Dev: uvicorn --reload. |
| `python-multipart` | 0.0.6+ | Multipart form parsing (file uploads, UI form submissions) | Required by Starlette. |

### Async & Concurrency

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `anyio` | 4.3+ | Async abstraction layer (TaskGroup, CancelScope) | Replaces asyncio context managers; cleaner cancellation semantics. |
| `asyncpg` | 0.30+ | PostgreSQL async driver, prepared statements, connection pooling | Zero-copy, C extension, 10x faster than psycopg3. |

### Database & Storage

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `sqlalchemy` | 2.0+ | ORM, async session, RLS query builders | SQLAlchemy 2.0: full async support, declarative row-level security. |
| `alembic` | 1.13+ | Database migrations, autogenerated schema diffs | Single source of truth: `migrations/versions/*.py` |
| `redis` | 5.0+ | Redis client, pub/sub, queue abstractions | Async client required (`redis.asyncio`). Sentinel/Cluster support. |
| `chromadb` | 0.5+ | Vector embedding store client, tenant-isolated collections | Interfaces with `embedding-model` (Sentence Transformers or OpenAI embeddings). |

### Authentication & Authorization

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `PyJWT` | 2.8+ | JWT decode/encode, claim extraction | Per SAD: JWKS public key verification in JWT middleware; no private key in app. |
| `httpx` | 0.27+ | Async HTTP client, JWKS endpoint polling | Fetches JWKS from Authentik; implements exponential backoff + caching. |
| `python-jose` | 3.3+ | Optional: JWT parsing if PyJWT insufficient | Avoid; PyJWT + httpx is cleaner. |

### Testing

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `pytest` | 7.4+ | Unit, integration, property-based test runner | Config: `pytest.ini` with markers (unit, integration, slow, sandbox). |
| `pytest-asyncio` | 0.23+ | Async test support, fixture scopes (function, session) | Required for all async code paths. |
| `hypothesis` | 6.98+ | Property-based testing, generative test data | **Binding requirement** per Task Manifest: all boundary fuzzing (K1–K8, ICD) use hypothesis. |
| `pytest-cov` | 4.1+ | Coverage tracking | Target: 80% line coverage minimum; 100% on Kernel, Sandbox, Egress (SIL-3). |
| `faker` | 25.0+ | Fake data generation (names, emails, UUIDs for fixtures) | Deterministic seed for reproducible tests. |

### Observability & Instrumentation

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `structlog` | 24.1+ | Structured JSON logging, context propagation, correlation IDs | Single canonical logger; all log lines are JSON parseable. |
| `prometheus-client` | 0.20+ | Metrics collection, Prometheus exposition format | Scraped by external Prometheus or CloudWatch. |
| `opentelemetry-api` | 1.22+ | Distributed tracing, span context propagation | Optional: integrates with Prometheus exporters for metrics. |

### Infrastructure & Isolation

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `grpcio` | 1.62+ | gRPC client/server (sandbox code execution requests/responses) | Bidirectional streaming for long-running code execution. |
| `protobuf` | 5.27+ | Protocol buffer serialization (gRPC message schemas) | Compiled from `sandbox/proto/execution.proto`. |
| `pydantic-grpc` | (optional) | Pydantic ↔ gRPC bridge for automatic proto generation | If used, document protobuf versions in schema files. |

### Code Quality & Linting

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `ruff` | 0.4+ | Linting (flake8, isort, pylint rules) + formatting (black) | Single tool; replaces flake8 + black + isort. Config: `pyproject.toml` [tool.ruff]. |
| `mypy` | 1.9+ | Static type checking, strict mode | Installed separately from ruff (ruff does not do type checking). |
| `pre-commit` | 3.7+ | Git hook management (runs ruff, mypy, trailing whitespace checks) | Config: `.pre-commit-config.yaml`. Every developer runs `pre-commit install`. |

### Utility Libraries

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `python-dotenv` | 1.0+ | Environment variable loading from `.env` | Dev only; production uses AWS Secrets Manager / Vault. |
| `pydantic-settings` | 2.2+ | Pydantic config from environment, with validation | Replaces python-decouple. Supports nested config objects. |
| `tenacity` | 8.3+ | Retry logic, exponential backoff, jitter | Used for JWKS polling, LLM API retries, database reconnects. |

---

## 3. Dependencies (Frontend)

### React Ecosystem

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `react` | 18.3+ | Core library | Suspense, concurrent rendering. |
| `react-dom` | 18.3+ | DOM rendering | Client-only (no SSR at v1.0). |
| `zustand` | 4.5+ | State management | Minimal, performant, TypeScript-native. Stores: chat, topology, goal, auth. |
| `@tanstack/react-query` | 5.45+ | Server state management, caching, background sync | Replaces fetch loops; automatic refetch on focus/reconnect. |

### UI & Visualization

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `recharts` | 2.12+ | Chart library (bar, line, pie for metrics/goal trees) | Lightweight, Recharts components are SVG, CSS animatable. |
| `d3` | 7.9+ | Complex topology graph visualization (agent network, goal dependencies) | Overkill for simple charts; paired with Recharts. |
| `react-flow-renderer` | (optional) | Node-edge graph for topology visualization | Alternative to d3; higher abstraction, easier interactivity. |
| `tailwindcss` | 3.4+ | Utility-first CSS framework | No CSS module; all styling via Tailwind classnames. |

### WebSocket & Real-Time

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `ws` (browser native) | N/A | WebSocket API (native; no polyfill needed for Node 20 users) | Use browser `WebSocket` constructor directly; no third-party wrapper. |
| Custom hook: `useWebSocket` | (local) | React hook wrapping WebSocket auto-reconnect, subscription management | Defined in `console/src/hooks/useWebSocket.ts`. |

### Development Tools

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `vite` | 5.1+ | Build tool, dev server | Config: `vite.config.ts`. |
| `@vitejs/plugin-react` | 4.3+ | JSX transformation plugin for Vite | Handles `.tsx` → JS. |
| `typescript` | 5.4+ | TypeScript compiler, type checking | Used by Vite during dev; tsc NOT run explicitly (Vite transpiles directly). |
| `prettier` | 3.3+ | Code formatter (console code only) | Config: `.prettierrc.json`. Enforced pre-commit hook. |
| `vitest` | 1.3+ | Vitest test runner (Jest-compatible, built on Vite) | Unit tests for components, hooks, stores. |
| `@testing-library/react` | 14.2+ | Testing utilities (render, userEvent, screen queries) | Query helpers for accessible testing. |
| `@testing-library/vitest` | (via testing-library) | Integration between Vitest and Testing Library | Matchers like `toBeInTheDocument()`. |

### Type Definitions

| Package | Version | Purpose | Notes |
|---------|---------|---------|-------|
| `@types/react` | 18.3+ | React type definitions | Pinned to React version. |
| `@types/react-dom` | 18.3+ | React DOM types | Pinned to React version. |

---

## 4. Repository Structure

The RTD v0.1.0.4 (mermaid) defines the target directory layout. **Critical directories exist in Phase A scaffold (step 4):**

```
holly-grace-archive/
├── holly/                          # Backend (L1–L4: Kernel, Core, Engine, Agents)
│   ├── kernel/                     # L1: Kernel (invariant library)
│   │   ├── context.py              # KernelContext async context manager
│   │   └── k1_k8.py                # K1–K8 invariant gates
│   ├── core/                       # L2: Orchestrator
│   │   ├── conversation.py         # Conversation interface
│   │   ├── intent.py               # Intent classifier
│   │   ├── goals/                  # Goal decomposition + hierarchy
│   │   ├── aps/                    # APS controller (T0–T3 tiers)
│   │   ├── topology/               # Team topology manager
│   │   └── memory/                 # 3-tier memory (Redis, PG, Chroma)
│   ├── engine/                     # L3: Execution Engine
│   │   ├── lanes/                  # Main, cron, subagent lanes
│   │   ├── mcp/                    # MCP tool registry + builtin tools
│   │   └── workflow/               # Durable workflow engine
│   ├── agents/                     # Agent implementations
│   │   ├── base.py                 # BaseAgent class
│   │   ├── prompts/                # Holly, researcher, builder, etc.
│   │   └── constitution/           # Celestial & Terrestrial predicates
│   ├── llm/                        # LLM routing (Claude, Ollama)
│   ├── api/                        # HTTP/WebSocket API
│   │   ├── middleware/             # JWT, CORS, rate limiting
│   │   ├── routes/                 # Chat, goals, topology, execution, audit
│   │   └── websockets/             # WebSocket manager (9 channels)
│   ├── observability/              # Logging, tracing, metrics
│   ├── storage/                    # PostgreSQL, Redis, ChromaDB clients
│   ├── safety/                     # Redaction, guardrails, egress
│   ├── infra/                      # Secrets manager, egress control
│   └── config/                     # Settings, hot reload
├── sandbox/                        # L3.5: Isolated code execution
│   ├── server.py                   # gRPC server
│   ├── executor.py                 # Code executor
│   ├── proto/                      # execution.proto (gRPC schema)
│   └── security/                   # Namespaces, seccomp, cgroups
├── console/                        # L5: React UI
│   ├── src/
│   │   ├── components/             # Chat, Topology, Goals, Execution, Audit
│   │   ├── hooks/                  # useWebSocket, useGoalTree, etc.
│   │   ├── stores/                 # Zustand stores
│   │   └── App.tsx
│   ├── vite.config.ts
│   └── tailwind.config.js
├── tests/                          # Test suite
│   ├── unit/                       # Unit tests per module
│   ├── integration/                # Component integration tests
│   └── e2e/                        # End-to-end tests (Selenium/Playwright optional)
├── deploy/                         # Deployment configs
│   ├── aws/                        # CloudFormation, ALB, ECS task defs
│   ├── authentik/                  # OIDC flows, RBAC policies
│   └── docker-compose.yml          # Local dev environment
├── migrations/                     # Alembic SQL migrations
├── scripts/                        # Utility scripts
│   ├── seed_db.py
│   ├── migrate.py
│   ├── dev.sh                      # Start local dev server
│   └── partition_maint.py
├── docs/                           # Documentation
│   ├── Dev_Environment_Spec.md     # This file
│   ├── ICD_v0.1.md                 # Interface Control Document (49 contracts)
│   ├── Component_Behavior_Specs_SIL3.md  # State machines for SIL-3 components
│   ├── Goal_Hierarchy_Formal_Spec.md
│   ├── SIL_Classification_Matrix.md      # SIL allocation (43 components)
│   ├── Test_Governance_Spec.md           # 62-control test governance
│   ├── Task_Manifest.md                  # 583 tasks, 15 slices
│   ├── Monograph_Glossary_Extract.md     # 104 symbols, theory-impl mapping
│   ├── architecture.yaml           # Extracted SAD, machine-readable (planned)
│   ├── sandbox-security.md         # (planned — slice 1+)
│   ├── egress-model.md             # (planned — slice 1+)
│   └── deployment-topology.md      # (planned — Phase N)
├── pyproject.toml                  # Python dependencies, tool configs
├── package.json                    # Console dependencies
└── .pre-commit-config.yaml         # Pre-commit hooks
```

**Scaffold Gate (Phase A, Step 4):** All directories created; verify no accidental traversals, no symlinks outside repo.

---

## 5. Branch Strategy

**Primary Branch:** `main` (GitHub) or `master` (GitLab) — protected, no direct commits after Slice 1.

**Feature Branches:** `slice-{N}/{step}-{description}`

Example: `slice-1/step-3-decorators`, `slice-2/step-8-ast-scanner`, `slice-6/step-36-goal-predicates`

**Hotfix Branches:** `hotfix/{issue-id}-{description}` (branched from main; merged back to main + current feature branch)

**Requirements:**
- All commits rebase onto main (no merge commits except for hotfixes)
- Every feature branch requires ≥1 approver before merge
- CI must pass completely (all stages) before merge button is clickable
- Merge commits to main are squashed into single commit per slice (for clean history)

---

## 6. CI/CD Pipeline

**Platform:** GitHub Actions (primary; GitLab CI as secondary mirror if mirroring is active)

**Pipeline Stages (Run on every push to PR or main):**

| Stage | Tool | Duration | Gate | Notes |
|-------|------|----------|------|-------|
| 1. Format Check | `ruff format --check` | <30s | Fail if formatting needed | No auto-fix in CI; developer must `ruff format` locally. |
| 2. Lint | `ruff check` | <2m | Warn on style; fail on errors | Rules: E501 (line length) disabled; Ruff default line width 88. |
| 3. Type Check | `mypy --strict` | <3m | Fail on type errors or missing annotations | 100% coverage on public APIs. |
| 4. Unit Tests | `pytest tests/unit/ -m unit` | <5m | Fail on test failure or <80% coverage | Coverage report uploaded to Codecov. |
| 5. Property-Based Tests | `pytest tests/unit/ -m hypothesis` | <10m | Fail on hypothesis failure or example shrinking failure | Hypothesis seed recorded; failure replay documented. |
| 6. Integration Tests | `pytest tests/integration/ -m integration` | <15m | Fail on failure; uses test PG, Redis, Chroma (docker containers) | Requires `docker compose up` in CI runner. |
| 7. Architecture Drift Detection | Custom: `python scripts/check_architecture.py` | <2m | Fail if SAD vs. codebase decorator mismatch | Checks all `@kernel_boundary`, `@tenant_scoped` decorators present; traces SAD → code. |
| 8. Fitness Functions | Custom: `python scripts/run_fitness_functions.py` | <5m | Fail if fitness threshold violated | Examples: ICD latency budget breach, RTM link broken, RLS policy drift. |
| 9. RTM Completeness | Custom: `python scripts/generate_rtm.py --validate` | <1m | Fail if RTM broken (requirement → decision → code → test broken link) | Generates living RTM; CI validates no dangling links. |
| 10. Security Scan (optional) | Trivy / Snyk | <2m | Warn on vulnerabilities; fail on CRITICAL | Advisory: run locally before push. |

**After Slice 1, Step 11 (CI Gate Activation):**
- All 9 stages must pass to merge to main.
- Stages 4–9 are binding (no override).
- Stages 1–3 are auto-fixable; developer expected to fix before re-push.

**Eval Pipeline (Phase K, Steps 66–69; activated in Slice 12):**
- Stage 10 (eval CI): `python scripts/run_evals.py --harness behavioral_suites` | <30m | Fail if eval regression detected (per-agent property-based + adversarial suites) | Blocks agent commits; constitution/prompt changes gated by eval pass. |

**Merge Requirements:**
- All stages pass.
- ≥1 approver (human review).
- Branch is up-to-date with main (no stale merges).
- Squash-and-merge (not rebase, not 3-way merge).

---

## 7. Formatting & Style Standards

### Python

**Formatter:** `ruff format`

- **Line Width:** 88 characters (Ruff default; Black-compatible)
- **Indentation:** 4 spaces (Python standard)
- **Imports:** Sorted by ruff (stdlib → third-party → local), grouped by type, with blank line between groups
- **Strings:** Double quotes (Ruff default); single quotes only in nested/raw strings where unescaped double quotes would need escaping

**Config in `pyproject.toml`:**
```toml
[tool.ruff]
line-length = 88
indent-width = 4

[tool.ruff.format]
quote-style = "double"
```

**Linting:** `ruff check`

- **Enable:** E (errors), W (warnings), F (PyFlakes), I (isort), UP (pyupgrade), C (comprehensions)
- **Disable:** E501 (line too long — handled by formatter), W503 (line break before binary operator — style preference)
- **Type annotations required** on all public functions and class methods (enforced by mypy, not ruff)

### TypeScript / React

**Formatter:** `prettier`

- **Line Width:** 100 characters (console convention; wider than backend because React JSX is more compact)
- **Indentation:** 2 spaces (JavaScript standard)
- **Trailing Commas:** ES5 (allow in arrays/objects, not function params)
- **Semicolons:** Required
- **Arrow Functions:** Always parenthesize params (even single params)

**Config in `console/.prettierrc.json`:**
```json
{
  "semi": true,
  "trailingComma": "es5",
  "printWidth": 100,
  "tabWidth": 2,
  "arrowParens": "always",
  "singleQuote": false
}
```

**Linting:** ESLint (optional; Prettier handles most formatting)

### Commit Messages

**Standard:** Conventional Commits (https://www.conventionalcommits.org/)

**Format:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type:** feat, fix, docs, style (formatting), refactor, test, chore, ci, perf

**Scope:** kernel, core, engine, agents, llm, api, observability, storage, safety, console, infra, deploy, etc.

**Subject:** Imperative mood, lowercase, no period. Max 50 characters.

**Body:** Explain WHAT and WHY, not HOW. Wrap at 72 characters. Reference ADRs if decision-based.

**Footer:** Optional. Reference GitHub issues or pull requests (e.g., `Closes #123`).

**Examples:**
```
feat(kernel): add K5 idempotency key generation per RFC 8785
fix(core): resolve goal decomposition race condition in lexicographic gating
docs(sandbox): update security model for gVisor escape vectors
test(api): add property-based tests for ICD-032 Kernel boundary schema
```

### Docstrings

**Style:** Google Style (https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings)

**Mandatory on:**
- All public functions/methods
- All public classes
- All public modules (module-level docstring)

**Format:**
```python
def invoke_kernel_gate(
    context: KernelContext, boundary_name: str, payload: Any
) -> KernelGateResult:
    """Invoke a single kernel invariant gate.

    Wraps a boundary crossing with K1–K8 invariant checks in sequence.
    Executed in-process (no network hop). Returns immediately on first
    failure or after all gates pass.

    Args:
        context: KernelContext instance (async context manager).
        boundary_name: Identifier of the boundary being crossed
            (e.g., 'MCP→Sandbox', 'Core→Engine'). Must be in SAD.
        payload: Request data (dict, Pydantic model, or raw bytes).
            Validated against ICD schema for boundary_name.

    Returns:
        KernelGateResult with:
            - passed: bool (all gates passed)
            - failed_gate: str or None (which gate failed, if any)
            - error: Exception or None
            - trace_id: UUID (for observability correlation)

    Raises:
        KernelViolation: If any gate fails (K1–K8).
        BoundsExceeded: If payload size exceeds boundary limits.
        timeout.Timeout: If gating exceeds SLA (typically 1ms).
    """
```

### Type Annotations

**Requirement:** 100% of public API signatures (functions, methods, class attributes accessible outside the module).

**Standard Library Types:**
```python
from typing import Any, Optional, Union, List, Dict, Tuple
from collections.abc import Iterator, Callable, Sequence
from datetime import datetime
from uuid import UUID
```

**Pydantic Models for DTO:**
```python
from pydantic import BaseModel, Field

class KernelGateRequest(BaseModel):
    boundary_name: str = Field(..., description="SAD boundary identifier")
    payload: Any = Field(..., description="Request data")
    timeout_ms: int = Field(default=1000, ge=100, le=10000)
```

**Async Functions:**
```python
async def process_boundary_crossing(
    context: KernelContext, request: KernelGateRequest
) -> KernelGateResult:
    """Process a boundary crossing with async kernel gates."""
```

---

## 8. Local Development Setup

### Prerequisites

- **macOS/Linux/WSL2** (Windows native not supported; use WSL2)
- **Git** 2.40+
- **Docker** + Docker Compose 2.20+

### Step-by-Step

**1. Clone Repository**
```bash
git clone https://github.com/yourusername/holly-grace.git
cd holly-grace
git checkout main
```

**2. Install Python 3.12+**

Using `pyenv` (recommended):
```bash
# macOS
brew install pyenv
pyenv install 3.13.0
pyenv local 3.13.0

# Linux (using pyenv)
curl https://pyenv.run | bash
# Add ~/.pyenv/bin to PATH, then:
pyenv install 3.13.0
pyenv local 3.13.0
```

Verify: `python --version` should show 3.13.0+

**3. Install `uv` Package Manager**
```bash
pip install uv
uv --version  # Verify
```

**4. Create Virtual Environment & Install Dependencies**
```bash
uv sync  # Creates venv in .venv/, installs all deps from uv.lock
source .venv/bin/activate
```

**5. Install Node 20 (for Console)**

Using `nvm` (recommended):
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
nvm install 20
nvm use 20
node --version  # Verify 20.x
```

**6. Install Frontend Dependencies**
```bash
cd console
pnpm install
cd ..
```

**7. Start Infrastructure (PostgreSQL, Redis, ChromaDB, Ollama)**
```bash
docker compose up -d
# Waits for services to be healthy (poll health checks)
```

Verify:
```bash
docker compose ps  # All containers RUNNING
psql -h localhost -U holly -d holly_dev -c "SELECT 1;"  # Should return 1
redis-cli ping  # Should return PONG
```

**8. Run Database Migrations**
```bash
python scripts/migrate.py  # Alembic upgrade head
```

**9. Start Backend Dev Server**
```bash
python -m uvicorn holly.api.app:app --reload --host 0.0.0.0 --port 8000
# Outputs: Uvicorn running on http://127.0.0.1:8000
```

**10. Start Frontend Dev Server (in another terminal)**
```bash
cd console
pnpm dev
# Outputs: Local: http://localhost:5173
```

**11. Verify Local Setup**

Open browser: http://localhost:5173

- Chat interface loads (WebSocket connects to localhost:8000)
- Can send messages to localhost:8000
- No auth required in dev mode (auth skipped if `ENVIRONMENT=dev`)

**12. Run Tests Locally**
```bash
# Backend
pytest tests/unit/ -m unit -v
pytest tests/unit/ -m hypothesis -v
pytest tests/integration/ -m integration -v

# Frontend
cd console
pnpm test
```

---

## 9. Environment Variables

### Backend (`.env` file in repo root)

**Required for Local Dev:**
```bash
# Database
DATABASE_URL=postgresql://holly:holly_password@localhost:5432/holly_dev
REDIS_URL=redis://localhost:6379/0
CHROMADB_URL=http://localhost:8000
OLLAMA_URL=http://localhost:11434

# LLM
CLAUDE_API_KEY=sk-ant-...  # From Anthropic console

# Auth (dev mode)
ENVIRONMENT=dev  # Skip JWT validation in dev
AUTHENTIK_ISSUER_URL=http://localhost:9000/application/o/holly/
AUTHENTIK_CLIENT_ID=holly-client
AUTHENTIK_CLIENT_SECRET=dev-secret-only

# Secrets
JWT_AUDIENCE=holly-api
JWT_SECRET=dev-only-secret-change-in-prod

# Safety
EGRESS_ALLOWLIST_PATH=./config/egress-allowlist.json
LOG_LEVEL=DEBUG

# Optional
HYPOTHESIS_SEED=0  # For reproducible property-based test failures
```

**Populated at Runtime (via AWS Secrets Manager or Vault in prod):**
```bash
# These are fetched by the app from KMS, not set in .env
# AUTHENTIK_CLIENT_SECRET (fetched from KMS)
# CLAUDE_API_KEY (fetched from KMS if env=prod)
# JWT_SECRET (loaded from KMS on startup)
# DB_PASSWORD (stored in RDS Secrets Manager)
```

### Frontend (`.env` in `console/`)

```bash
VITE_API_BASE_URL=http://localhost:8000
VITE_LOG_LEVEL=debug
VITE_ENVIRONMENT=development
```

### Git / Pre-commit Configuration

Create `.env.local` (git-ignored) with sensitive values:
```bash
# .env.local (gitignore'd)
CLAUDE_API_KEY=sk-ant-...
```

Load in shell profile:
```bash
# ~/.bashrc or ~/.zshrc
if [ -f ~/holly-grace/.env.local ]; then
  set -a
  source ~/holly-grace/.env.local
  set +a
fi
```

---

## 10. Docker Compose (Development)

**File:** `docker-compose.yml` (in repo root)

**Services:**

### PostgreSQL 16
```yaml
postgres:
  image: postgres:16-alpine
  environment:
    POSTGRES_USER: holly
    POSTGRES_PASSWORD: holly_password
    POSTGRES_DB: holly_dev
  ports:
    - "5432:5432"
  volumes:
    - postgres_data:/var/lib/postgresql/data
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U holly -d holly_dev"]
    interval: 2s
    timeout: 5s
    retries: 10
```

### Redis 7 (Sentinel for HA, but single-node in dev)
```yaml
redis:
  image: redis:7-alpine
  ports:
    - "6379:6379"
  volumes:
    - redis_data:/data
  command: redis-server --appendonly yes  # Enable AOF persistence
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 2s
    timeout: 5s
    retries: 10
```

### ChromaDB
```yaml
chromadb:
  image: chromadb/chroma:latest
  ports:
    - "8000:8000"
  environment:
    ANONYMIZED_TELEMETRY: "false"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
    interval: 5s
    timeout: 5s
    retries: 5
```

### Ollama (Local LLM Inference)
```yaml
ollama:
  image: ollama/ollama:latest
  ports:
    - "11434:11434"
  volumes:
    - ollama_data:/root/.ollama
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
    interval: 10s
    timeout: 5s
    retries: 5
```

**Volumes (Named, persisted across restarts):**
```yaml
volumes:
  postgres_data:
  redis_data:
  ollama_data:
```

**Usage:**
```bash
# Start all services
docker compose up -d

# View logs
docker compose logs -f postgres redis chromadb

# Tear down (preserve volumes)
docker compose down

# Full clean (remove volumes)
docker compose down -v
```

---

## 11. Architecture Decision Record (ADR) Template

Every design decision that affects the codebase (technology choice, data model, API design, safety mechanism) requires an ADR.

**Location:** `docs/adr/ADR-{NNN}.md`

**Numbering:** 001, 002, etc. (in order of creation, not order of decision)

**Template:**

```markdown
# ADR-{NNN}: {Title}

**Date:** YYYY-MM-DD
**Status:** {Proposed | Accepted | Deprecated | Superseded by ADR-NNN}
**Audience:** Developers, Architecture Review Board

## Context

Describe the decision point. What triggered this decision? What problem are we solving?
Reference related ADRs, standards (ISO 42010, 25010), or roadmap steps.

Example:
> Slice 1, Step 3 requires decorator registry to enforce architecture contracts.
> We must choose how decorators integrate with the SAD parser (architecture.yaml)
> and which Python decorator framework to use.

## Options Considered

1. **Option A: Python stdlib decorators**
   - Pros: No external dependency
   - Cons: Limited introspection at module load time

2. **Option B: Custom decorator registry (chosen)**
   - Pros: Full control, integration with architecture.yaml validation
   - Cons: Additional code to maintain

## Decision

We choose Option B.

### Design

[Describe the chosen approach with sufficient detail for implementation.]

### Quality Attributes (ISO 25010)

- **Maintainability:** Registry centralized in one module (holly/architecture/decorators.py); all decorators inherit from base Decorator class. +High
- **Correctness:** Decorators validated at app startup against architecture.yaml; CI fitness function ensures all boundaries decorated. +High
- **Performance:** Decoration is zero-cost at runtime (metadata only); registry lookup O(1). +High

## Consequences

### Positive
- Enforces architectural contracts at code level (not documentation)
- Enables AST scanner to validate decorator presence/consistency
- Fitness functions can auto-detect violations

### Negative
- Adds boilerplate: every boundary crossing requires explicit decorator
- Training curve for new developers (must understand decorator semantics)

### Risks
- Developers may forget decorators on new boundaries (mitigated by CI gate + code review)

## Verification

- [ ] Acceptance test: `@kernel_boundary` decorator applied to all K1–K8 invariant gates
- [ ] CI fitness function passes (no undecorated boundary crossings)
- [ ] Architecture.yaml ↔ decorated code round-trip: 100% coverage

## Related ADRs

- ADR-002: architecture.yaml schema design
- ADR-008: CI gate automation

## References

- ISO 42010:2022 § 7.4 (viewpoint correspondence rules)
- SAD v0.1.0.5 (Kernel → Core boundaries)
```

---

## 12. Compliance & Binding Rules

### 12.1 Environment Specification Adherence

This document is binding. Deviations are only permitted with an ADR.

**Examples of violations (require ADR before execution):**
- Pinning a different version of Python, Node, or core dependency
- Adding a new build tool (e.g., switching from Vite to Webpack)
- Changing line width, quote style, or formatting rules
- Introducing a new state management library (instead of Zustand)

**Examples of non-violations (no ADR required):**
- Installing a new testing library (e.g., faker) as a dev dependency
- Adding a new third-party Python package for non-core functionality
- Writing additional unit tests or documentation

### 12.2 Code Review Checklist

Every PR must satisfy:

- [ ] Code formatted with `ruff format` and `prettier`
- [ ] Linting passes: `ruff check`
- [ ] Type checking passes: `mypy --strict` (100% coverage on public APIs)
- [ ] All tests pass locally: `pytest tests/` -v
- [ ] No test skips (`@pytest.mark.skip`) except in approved issues (link required in comment)
- [ ] Docstrings present on all public functions/classes (Google style)
- [ ] Commit messages follow Conventional Commits
- [ ] If adding a dependency: justify in PR description + add to this spec + update `pyproject.toml` and `uv.lock`
- [ ] If changing behavior: update relevant architecture docs (SAD, ICD, behavior spec, goal hierarchy)

### 12.3 SIL-Based Verification Requirements

| Component | SIL | Testing | Type Checking | Formal Spec | ADR Required |
|-----------|-----|---------|---------------|-------------|--------------|
| Kernel (K1–K8) | SIL-3 | 100% + hypothesis | 100% strict mypy | TLA+ model check | Yes, on any change |
| Sandbox (isolation) | SIL-3 | 100% + hypothesis + adversarial | 100% strict mypy | TLA+ model check | Yes, on any change |
| Egress (filtering) | SIL-3 | 100% + hypothesis | 100% strict mypy | TLA+ formal spec | Yes, on any change |
| Core (orchestration) | SIL-2 | 80% + integration | 100% strict mypy on public APIs | Behavior spec (state machines) | Maybe (review-dependent) |
| Engine (workflows) | SIL-2 | 80% + integration | 100% strict mypy on public APIs | Behavior spec | Maybe (review-dependent) |
| Storage (DB, cache) | SIL-2 | 80% | 90% strict mypy | None | No |
| Console (UI) | SIL-1 | 60% + e2e spot checks | 90% strict TypeScript | None | No |
| Config, utilities | SIL-1 | 60% | 80% strict mypy | None | No |

### 12.4 Mandatory Security Reviews

The following changes require a security review before merge (in addition to code review):

- Any change to Kernel (K1–K8), Sandbox, Egress, or Auth
- Any change to `holly/safety/` (redaction, guardrails)
- Any change to `holly/infra/` (secrets, egress control)
- Any change to `deploy/` (infrastructure config, deployment topology)

Security review must sign off on: OWASP coverage, CWE-relevant mitigations, threat model alignment.

---

## 13. Troubleshooting

### Common Issues

**"uv: command not found"**
```bash
pip install --upgrade uv
```

**"ModuleNotFoundError: No module named 'holly'"**
```bash
# Ensure .venv is activated
source .venv/bin/activate
# Reinstall in dev mode
uv sync
```

**"Docker container fails to start"**
```bash
docker compose down -v  # Remove volumes
docker compose up -d    # Start fresh
```

**"Tests hang on asyncio.run() or pytest-asyncio fixture"**

Ensure `pytest.ini` has:
```ini
[pytest]
asyncio_mode = auto
```

**"Mypy errors on Pydantic models"**

Install Pydantic mypy plugin:
```bash
uv pip install pydantic-mypy
```

Add to `pyproject.toml`:
```toml
[tool.mypy]
plugins = ["pydantic.mypy"]
```

**"WebSocket connection fails (console ↔ backend)"**

Check:
1. Backend running: `curl http://localhost:8000/health`
2. Frontend VITE_API_BASE_URL env var: `echo $VITE_API_BASE_URL` (should be http://localhost:8000)
3. Console dev server logs: `pnpm dev` output should show no build errors

---

## 14. References & Further Reading

### Key Standards

- **ISO 42010:2022** — Architecture Description (viewpoints, correspondence, SADs)
- **ISO 25010:2023** — System and Software Quality (quality attributes)
- **ISO 15288:2023** — System Lifecycle Processes (verification, V&V)
- **NIST SP 800-39** — Risk Management Framework

### Design Methodology

- Allen (2026) — *Informational Monism, Morphogenetic Agency, and Goal-Specification Engineering* (theoretical foundation)
- README.md § Meta Procedure (14-step discipline, spiral execution)
- Design_Methodology_v1.0.docx (detailed methodology + case studies)

### Tool Documentation

- [Ruff](https://docs.astral.sh/ruff/) — Linting & formatting
- [Mypy](https://mypy.readthedocs.io/) — Type checking
- [Pydantic v2](https://docs.pydantic.dev/latest/) — Data validation
- [Hypothesis](https://hypothesis.readthedocs.io/) — Property-based testing
- [Pytest](https://docs.pytest.org/) — Testing framework
- [Starlette](https://www.starlette.io/) — HTTP framework
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/14/) — ORM
- [Alembic](https://alembic.sqlalchemy.org/) — Migrations
- [Vite](https://vitejs.dev/) — Frontend build tool
- [Zustand](https://github.com/pmndrs/zustand) — State management
- [React 18](https://react.dev/) — UI framework
- [Tailwind CSS](https://tailwindcss.com/) — Styling

### Internal Documents

- `docs/architecture/SAD_0.1.0.5.mermaid` — System Architecture Document (L0–L5, 48 components)
- `docs/ICD_v0.1.md` — All 49 boundary contracts
- `docs/Component_Behavior_Specs_SIL3.md` — State machines for SIL-3 components
- `docs/Goal_Hierarchy_Formal_Spec.md` — L0–L6 predicates, feasibility algorithms
- `docs/Monograph_Glossary_Extract.md` — Ontological definitions (from Allen 2026)
- `docs/architecture.yaml` — Machine-parsed SAD *(planned — slice 1)*
- `docs/glossary.md` — Consolidated glossary *(planned — slice 1)*

---

## 15. Revision History

| Date | Version | Author | Change |
|------|---------|--------|--------|
| 2026-02-17 | 1.0 | Architecture Team | Initial specification (extracted from SAD v0.1.0.2, RTD v0.1.0.2, Task Manifest v1.0) |

---

**Document Status:** ACCEPTED
**Next Review:** 2026-04-17 (end of Slice 1)
**Owner:** Architecture Review Board
